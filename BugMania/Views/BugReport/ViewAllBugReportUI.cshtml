@model IEnumerable<BugMania.Shapes.BugReport>


@{
    ViewBag.Title = "Home";
}
<div id="report-container" class="div-margin-10">
    <div class="container-fluid">
        <div class="row m-b-10">
            <div class="col-sm-6">
                @Html.ActionLink("+", "Create", "CreateBugReport", null,
                    new { @class = "btn btn-success glyphicon btn-link-text color-white pull-left",
                        Title = "Create Report" })
            </div>
            <form class="col-sm-6">
                @using (Html.BeginForm("View", "ViewAllBugReport", FormMethod.Get))
                {
                    <input type="search" name="filter" class="form-control pull-right searchbox" placeholder="Search" />
                }
            </form>
        </div>
        <div class="min-height-20">
            @if (!String.IsNullOrEmpty(ViewBag.Filters))
            {
                <a class="inline-block card-info search-filter-tag btn-link-text float-right" href="@Url.Action("View", "ViewAllBugReport")">
                    @ViewBag.Filters   <b>x</b>
                </a>
            }
        </div>
    </div>
    <hr />
    <div id="result">
        @Html.Partial("/Views/BugReport/_ViewBugReportCardUI.cshtml")
    </div>
</div>


@section Scripts  {
    @Scripts.Render("~/bundles/jqueryval")

    <script type="text/javascript">
        
        $("#main-content").scroll(function () {
            console.log('c' + $("#main-content").scrollTop());
            console.log('w' + $(window).height());
            console.log('r' + $("#report-container").height());
            console.log('---------------------')
            if ($("#main-content").scrollTop() + $(window).height() >= $("#report-container").height() + $(window).height() * 0.1) {
                
                FetchDataFromServer();
            }
        });

        var skipCount = 10; // start at 11th record (assumes first 10 included in initial view)
        var takeCount = 10; // return new 5 records
        var hasMoreRecords = true;
        var retrievingRecords = false;

        function FetchDataFromServer() {
            
            if (!hasMoreRecords || retrievingRecords) {
                return;
            }
            retrievingRecords = true;

            var filterString = window.location.search.split("=");
            
            if (filterString[0] != "") {
                filterString = filterString[1];
            }
            else {
                filterString = filterString[0];
            }

            $.ajax({
                url: '@Url.Action("FetchData", "ViewAllBugReport")',
                data: { skipCount : skipCount, takeCount: takeCount, filter: filterString },
                datatype: 'html',
                success: function (data) {
                    if (data == "") {
                        hasMoreRecords = false; // signal no more records to display
                    } else {
                        $("#result").append(data);
                        skipCount += takeCount; // update for next iteration
                    }
                    retrievingRecords = false;
                },
                error: function () {
                    retrievingRecords = false;
                    alert("Error loading more pages");
                }
            });
        }
    </script>
}